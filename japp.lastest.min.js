var japp=new function(){var that=this;function J(a,b){var c=a.find("*[data-repeat]"),c=Array.prototype.slice.call(c,0);c.reverse();null!=c&&($.each(c,function(a,b){$elem=$(b);b.hasAttribute("data-rep-id")||($elem.attr("data-rep-id",x),A[x]=b.outerHTML,x++)}),$.each(c,function(a,c){if($elem=$(c),!$elem.attr("data-rep-i")){var e=$elem.attr("data-repeat"),h=$elem.attr("data-var"),l=p(e,b);null!=l&&void 0!=l||(l=[]);t[b.name,e+".length"]=l.length;$elem.attr("data-rep-id");$elem.attr("data-rep-model",b.name+"."+e+".length");
q(b.name,e+".length");var e=g.replaceAll(e,"$model.",""),k="";0!=l.length?$.each(l,function(a,c){$elem.attr("data-rep-i",a);$clone=$elem.clone();var d=$elem.html(),d=g.replaceAll(d,"$"+h,"japp.bean('"+b.name+"')."+e+"["+a+"]");$clone.html(g.replaceAll(d,h,e+"["+a+"]"));$.each(B,function(b,c){var d=$clone.attr("data-"+c)||null;null!=d&&(d=g.replaceAll(d,h,e+"["+a+"]"),$clone.attr("data-"+c,C(d)))});k+=$clone[0].outerHTML}):($elem.attr("data-rep-i",0),$elem.css("display","none"),k=c.outerHTML);$elem.replaceWith(k)}}))}
function K(a,b){if(-1==b.indexOf("'")){var c=$("*[data-rep-model='"+b+"']"),d=c.length;if(0!=d){var f=b.split(".")[0],e=$(document.querySelector('*[data-bean="'+f+'"]')).find("*[data-repeat]").parent();for(i=0;i<d;i++){$elem=$(c[i]);$.each($elem,function(a,b){$elemObj=$(b);"0"!=$elemObj.attr("data-rep-i")&&$elemObj.remove()});var g=$elem.attr("data-rep-id");$elem.replaceWith(A[g])}y(f,e)}}}function p(a,$model){try{return eval(a+" || ''")}catch(c){return c+""}}function q(a,b,c){if(void 0!=b&&null!=g.beans[a]){var d=
n[a]||[];-1==d.indexOf(b)&&d.push(b);n[a]=d;void 0==c&&(c=p(b,g.beans[a]));t[a+"."+b]=c}}function L(a,b){$.each(B,function(c,d){var f=a.find("*[data-"+d+"]");$.each(f,function(a,c){if(!c.hasAttribute("data-m-ok")&&!c.hasAttribute(d)){var f=$(c).attr("data-"+d),k=f;miscNormalizedValue=(-1!=k.indexOf("{{")&&(k=g.replaceAll(k,"{{","'+("),k="'"+g.replaceAll(k,"}}",")+'")+"'"),k);f!=miscNormalizedValue&&($(c).attr("data-"+d,miscNormalizedValue),f=miscNormalizedValue);q(b.name,f);k="jm_"+D;D++;$(c).attr("data-id",
k);var n=u[b.name+"."+f]||[];n.push({id:k,data_misc:d});u[b.name+"."+f]=n;f=p(f,b);$(c).attr(d,f);$(c).attr("data-m-ok","ok")}})})}function y(a,b){g.renderAll(b,g.bean(a));b.find("input[data-value]").each(function(){if(!$(this).attr("tw")){var c=g.replaceAll($(this).attr("data-value"),"$model.","");$(this).attr("tw","ok");$(this).attr("oninput",";japp.bean('"+a+"')."+c+"=$(this).val();japp.eventS=$(this);japp.updateState();"+($(this).attr("oninput")||""))}});b.find("select[data-value]").each(function(){if(!$(this).attr("tw")){var c=
g.replaceAll($(this).attr("data-value"),"$model.","");$(this).attr("tw","ok");$(this).attr("onchange","japp.bean('"+a+"')."+c+"=$(this).val();japp.eventS=$(this);japp.updateState();"+($(this).attr("onchange")||""))}})}function v(a){if(r){void 0==a&&(a=n);var b=!1;$.each(a,function(a,d){if(null!=d)for(i=0;i<d.length;i++){var f=d[i],e=t[a+"."+f],h=p(f,g.bean(a));if(null==e||e!=h)g.update(a+"."+d[i]),t[a+"."+f]=h,e=E[a+"."+d[i]]||null,null!=e&&(f=g.bean(e.split(".")[0]),e=g.replaceAll(e.split(".")[1],
"$model",""),h=g.replaceAll(d[i],"$model.",""),eval("that.beans['"+f.name+"']."+e+"=that.beans['"+a+"']."+h),b=!0)}});b&&v()}}function F(a,b){for(var c in a)c.split(".")[0]==b&&delete a[c]}function C(a){return a=g.replaceAll(a,"&gt;",">"),a=g.replaceAll(a,"&lt;","<"),g.replaceAll(a,"&amp;","&")}var g=this,u={};this.beans={};var n={},z=0,B=["href","src","value","style","class"],G={},E={},t={};this.component=function(a,b){G[a]=b};var H=0,x=0,A={},w={},D=0;this.renderAll=function(a,b){J(a,b);var c=a.find("comp");
for(i=0;i<c.length;i++){var d,f=c[i];d=f.getAttribute("name");var e=G[d],h=d+H;if(e.hasOwnBean){var l=f.getAttribute("model");d=g.bean(h,e.bean);d.isComponentBean=!0;q(d.name,"model");q(b.name,l);d.model=p(l,b);E[b.name+"."+l]=d.name+".model"}else d=b;result=e.render($(f),d,h);$(f).replaceWith(result);$replacedObj=$("#"+h);y(d.name,$replacedObj);e.hasOwnBean&&$replacedObj.attr("data-bean",d.name);H++}c=[];for(e=document.createTreeWalker(a[0],NodeFilter.SHOW_TEXT,null,!1);f=e.nextNode();)c.push(f);
f=/{{\s*(.*?)\s*}}/g;for(i=0;i<c.length;i++)for(e=c[i].nodeValue;m=f.exec(e);){h=C(m[1]);d=p(m[1],b);q(b.name,h,d);var h=b.name+"."+h,l="_"+z,k=w[h]||[];-1==k.indexOf(l)&&k.push(l);w[h]=k;e=japp.replaceAll(e,"{{"+m[1]+"}}",'<span id="_'+z+'">'+d+"</span>");z++;$(c[i]).replaceWith(e)}L(a,b);c=a.find("*[data-event]");f=c.length;for(i=0;i<f;i++)e=c[i].getAttribute("data-event").split(","),c[i].setAttribute(e[0],"japp.bean('"+b.name+"')."+e[1])};var M=new function(){this.get=function(a){return g.beans[a]};
this.injectAll=function(a,b){for(i=0;i<b.length;i++)a[b[i]]=g.beans[b[i]]}},I=!0,r=!1;this.run=function(a,b){r=!1;I&&$.each(g.beans,function(a,b){b.construct&&b.construct(M)});var c=$(document.querySelector(a+" *[data-bean]")),c=Array.prototype.slice.call(c,0);c.reverse();$.each(c,function(a,b){var c=$(b).attr("data-bean");y(c,$(b))});null!=b&&b();I=!1;r=!0;v()};this.updateState=function(){v()};var N=function(a,b){var c=document;$.each(w[b]||[],function(b,f){var e=c.querySelector("span#"+f);null!=
e&&(e.innerHTML=a)})},O=function(a,b){var c=u[b];null!=c&&$.each(c,function(b,c){null==g.eventS?$("*[data-id='"+c.id+"']").each(function(){this.setAttribute(c.data_misc,a);"SELECT"==this.tagName&&"value"==c.data_misc&&(console.log("val"),$(this).val(a))}):g.eventS.attr("data-id")!=c.id&&$("*[data-id='"+c.id+"']").each(function(){"SELECT"==this.tagName&&"value"==c.data_misc&&(console.log("val"),$(this).val(a));this.setAttribute(c.data_misc,a)})})};this.update=function(a){r=!1;var b;b=g.bean(a.split(".")[0]);
var c=a.substring(a.split(".")[0].length+1,a.length);b=p(c,b);K(b,a);N(b,a);O(b,a);r=!0};var P=function(){this.construct=function(a){this.bean=a};this.set=function(a,b){this.bean[a]=b;tempObj={};tempObj[this.bean.name]=n[this.bean.name];v(tempObj);tempObj=null};this.get=function(a){return this.bean[a]}};this.bean=function(a,b){if(null==this.beans[a]){var c=new P;this.beans[a]=new b(c);this.beans[a].name=a;c.construct(this.beans[a])}return this.beans[a]};this.clean=function(a){a=a.find("*[data-bean]");
$.each(a,function(a,c){$elem=$(c);var d=$elem.attr("data-bean");F(w,d);F(u,d);delete n[d];g.beans[d].isComponentBean&&delete g.beans[d]})};this.replaceAll=function(a,b,c){return a.split(b).join(c)}};
